from hashlib import sha256
from Crypto.Cipher import ChaCha20

load("ecdsa.sage")


if __name__ == "__main__":
    _, E, G, n = params()
    messages2 = [
        b"This is message number 0",
        b"This is message number 1",
        b"This is message number 2",
        b"This is message number 3",
        b"This is message number 4",
        b"This is message number 5",
        b"This is message number 6",
        b"This is message number 7",
        b"This is message number 8",
        b"This is message number 9",
        b"This is message number 10",
        b"This is message number 11",
        b"This is message number 12",
        b"This is message number 13",
        b"This is message number 14",
        b"This is message number 15",
        b"This is message number 16",
        b"This is message number 17",
        b"This is message number 18",
        b"This is message number 19",
    ]
    signatures2 = [
        (
            36862367164919741003328514461110063229719266960258291161590528519965725586391915699151761914515349752495682127064478,
            3497719383671970382593316173756858887197468973326580871852467161102749410184752499256524935931649257235444531468055,
        ),
        (
            28461998444310225411012171237581868750617248511396661908930241066840449034901037608848132931026731999222914149715444,
            18017608977371706504637705543506127508241209196629019527614570296494288312657891422245364251332165441848038395263054,
        ),
        (
            25792413555992805465654673269383153707689634533616346431323059891451281303500546140805035177034448830667822727939608,
            4718895036590137929618211391183418986105410742854830623615562828578992656581467161211988383578477429574442476468159,
        ),
        (
            34313205440604360692106982387323794733760311130398297951199591915014679862217109222017835797657405534768192949713756,
            24677389219574920031455364404690833611324706335465728381209299664255253749132359898086212881977933794153192723868834,
        ),
        (
            26270968966165742719514479252426110556284126979904097304204367121767650066913274379895595073967728931190307814979707,
            6097635274982679169887185947983113548060627508282292725210551611119760791308260515900632275267052461499136823025409,
        ),
        (
            28540554115943232139040263504994871218118303190396990856755281100251733709579974826279273628336574530552088976913116,
            17854675345778644271128394591026454628626090818747719848806433953939677722496822942345638618694702481471440136324382,
        ),
        (
            30439814946977407827351932935225516444452471935418647524393282196351073585410221148479975111184446744504687731370354,
            26149373143378501277885971039338829294842585834293710396993918733579577237341688301174557911139779469902725896326608,
        ),
        (
            18457237749535630699297446538101280462140918867814796660945182092507902356649030747323942012327252228626736229427930,
            17006975802748028013128819728078953661512022281381090222848294439499397714897124125210982022008797767847669841448346,
        ),
        (
            29016831729799215332505170096415210038108757598368960467751673687901281736665588740282433125051557560386588105172048,
            9449586538481477595911784804846881333611555805327032995860648671545097931421440583363345934602693842866484345720765,
        ),
        (
            13783482961357362300320198829660539429115403590208266057277588308291692363207551418992934878520279396456143387769443,
            30199309679239230892231928008778843706577484107748243619163469542486270665797545007544903088905706775621975585970982,
        ),
        (
            22946445695583219843757717304218150216722851787772953894931097616858518113633842698668566240674553325996594966898651,
            25502627786678159894712279695782951406941594951863186539785757849430062911184471435704566740855673312904382331299455,
        ),
        (
            28233478177050060410367405617911208974696566513816822686173269882302393925906127490133091551488689332044938405473628,
            5987039927103670360978146430716891826898473897830482898372778239400139489799377356014757458532257101007352680849260,
        ),
        (
            12761300292453977769962003974365411608309642408280485673154923022500344377717760104344647954572016278626244646710332,
            29978106809305640480664266470794825498341466297162013781277417011028790794548806638654100978139333253333947575155998,
        ),
        (
            6264795001659886103730816894274078872074288611075035996248338331597328925416336475512720726435435064162107401317839,
            38215755359416047574533264446501556925890020769278279666303184377798532456444115537625796165946903059594266772668307,
        ),
        (
            34753629199761194988947226377653934429531104045917895690640151404368716992210639739175929279437227823889091107270528,
            32831738624938368535781637698050039224365437246658136192064570729023683221625537325380222627677366273496912641547592,
        ),
        (
            34761524733970348406165769446360857975829753237886856202231043083312783042430937359753324766561670210574806240508626,
            2915585449926052224307512249985173735989963222559725990923364357522177448591083225368827736540168195055426264325658,
        ),
        (
            33066162829898956680337427167934448031945673837943036112054566881016866469976770055842822566894154494753187377571823,
            26451275413126196174115405577947621697513542251514920886173595955189401839163721736967971752469060286273223275273988,
        ),
        (
            25502724270820722691176009576226841759878490940071987505974766845580776796943302676997797739201543502397495687405846,
            34570702255808704039152757706236546101784089714129803231805348871353208130618829773789548573493756790787470503468908,
        ),
        (
            33845498146572043831937976981967123857647082778283597171562326031814561085086557969495499863528393982911882084762888,
            6439773252796053065850894600929335427269871509516136611120962812948698170651983177872391921658132349551906494398218,
        ),
        (
            34497126197700655313139245659066172620937946688295103893500798665107816347812574755493179302718729237916127115154794,
            28929035221765716241721363848967883460785337388059317268130333131648539027075666032113246572381267496757649293122849,
        ),
    ]
    A2 = (
        21709774648437266106603430703946549997271669155720866416441778801227287616121586375407461000033329122812777833382113,
        36264128682840048136371344543624493862217408196732981540335267169897772715295459596475598997900535416123798203353597,
    )

    F = Integers(n)
    size_n = ceil(log(n, 2) / 8)
    nonce = b"\x00" * 24

    candidates = set()

    for i, (m, (r, s)) in enumerate(zip(messages2, signatures2)):
        key = sha256(m).digest()
        cipher = ChaCha20.new(key=key, nonce=nonce)
        k = int.from_bytes(cipher.encrypt(b"\x00" * size_n), byteorder="big")

        r = F(r)
        s = F(s)
        k = F(k)
        a = (s * k - F(h(m))) / r
        candidates.add(int(a % n))

    for candidate in candidates:
        public = (candidate * G).xy()
        if public[0] == A2[0] and public[1] == A2[1]:
            print("Got it!")
            print("The private key is:", candidate)
